!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).slardarPluginImageReport=t()}(this,function(){"use strict";var L=function(){return(L=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function v(e,a,u,c){return new(u=u||Promise)(function(n,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function o(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(r,o)}i((c=c.apply(e,a||[])).next())})}function h(r,o){var i,a,u,c={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(n){return function(e){var t=[n,e];if(i)throw new TypeError("Generator is already executing.");for(;c;)try{if(i=1,a&&(u=2&t[0]?a.return:t[0]?a.throw||((u=a.return)&&u.call(a),0):a.next)&&!(u=u.call(a,t[1])).done)return u;switch(a=0,(t=u?[2&t[0],u.value]:t)[0]){case 0:case 1:u=t;break;case 4:return c.label++,{value:t[1],done:!1};case 5:c.label++,a=t[1],t=[0];continue;case 7:t=c.ops.pop(),c.trys.pop();continue;default:if(!(u=0<(u=c.trys).length&&u[u.length-1])&&(6===t[0]||2===t[0])){c=0;continue}if(3===t[0]&&(!u||t[1]>u[0]&&t[1]<u[3])){c.label=t[1];break}if(6===t[0]&&c.label<u[1]){c.label=u[1],u=t;break}if(u&&c.label<u[2]){c.label=u[2],c.ops.push(t);break}u[2]&&c.ops.pop(),c.trys.pop();continue}t=o.call(r,c)}catch(e){t=[6,e],a=0}finally{i=u=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}}function z(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function x(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,o,i=n.call(e),a=[];try{for(;(void 0===t||0<t--)&&!(r=i.next()).done;)a.push(r.value)}catch(e){o={error:e}}finally{try{r&&!r.done&&(n=i.return)&&n.call(i)}finally{if(o)throw o.error}}return a}function s(e,t,n){if(n||2===arguments.length)for(var r,o=0,i=t.length;o<i;o++)!r&&o in t||((r=r||Array.prototype.slice.call(t,0,o))[o]=t[o]);return e.concat(r||Array.prototype.slice.call(t))}function t(e){return"object"==typeof e&&null!==e}function r(e){return"function"==typeof e}function l(n,r,o){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];n[r]=o.apply(void 0,s([n[r]],x(e),!1))}}var o=0,R=function(e){return Math.random()<Number(e)};function M(){if("object"==typeof window&&t(window))return window}function C(){if("object"==typeof document&&t(document))return document}var i=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=function(e){if(e)return e.__SLARDAR_REGISTRY__||(e.__SLARDAR_REGISTRY__={Slardar:{plugins:[],errors:[]}}),e.__SLARDAR_REGISTRY__.Slardar}(M());n&&(n.errors||(n.errors=[]),n.errors.push(e))},N=function(e,t){var n=e&&new e(t);return[function(e,t){n&&e&&n.observe(e,t)},function(){return n&&n.disconnect()}]},T=function(n){var e=n&&n.timing||void 0;return[e,function(){return n&&n.now?n.now():(Date.now?Date.now():+new Date)-(e&&e.navigationStart||0)},function(e){var t=(n||{}).getEntriesByType;return r(t)&&t.call(n,e)||[]},function(){var e=(n||{}).clearResourceTimings;r(e)&&e.call(n)},function(e){var t=(n||{}).getEntriesByName;return r(t)&&t.call(n,e)||[]}]},D=function(n,o,t,i){var r=n&&new n(function(e,r){e.getEntries?e.getEntries().forEach(function(e,t,n){return o(e,t,n,r)}):i&&i(),t&&r.disconnect()});return[function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(!n||!r)return i&&i();try{t.forEach(function(e){-1<n.supportedEntryTypes.indexOf(e)&&r.observe({type:e,buffered:!1})})}catch(e){try{r.observe({entryTypes:t})}catch(e){return i&&i()}}},function(){return r&&r.disconnect()}]};var k=function(n,e){return void 0===n&&(n="SlardarPlugins"),(e=void 0===e?!1:e)?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return console.log.apply(console,s(["[".concat(n,"] ")],x(e),!1))}:function(){}},e=(n.prototype.subscribe=function(e){this.observers.push(e)},n.prototype.unsubscribe=function(t){this.observers.filter(function(e){return e!==t})},n.prototype.notify=function(t){this.observers.forEach(function(e){e(t)})},n);function n(){this.observers=[]}function a(e){var t=[];return Array.from(e).forEach(function(e){e instanceof Element&&("img"===e.nodeName.toLocaleLowerCase()?t.push(e):null!=e&&e.querySelectorAll&&(e=e.querySelectorAll("img"),t=t.concat(Array.from(e))))}),t}var A=function(e){var t=[],n=[];return(e=void 0===e?[]:e).forEach(function(e){t.push.apply(t,s([],x(a(e.addedNodes)),!1)),n.push.apply(n,s([],x(a(e.removedNodes)),!1))}),[t,n]},u="undefined"!=typeof IntersectionObserver,j=(c.prototype.set=function(e){var t;u&&null!=(t=this.intersectionObserver)&&t.observe(e),this.record.set(e,{visible:!1,observer:this.intersectionObserver})},c.prototype.del=function(e){var t;null!=(t=this.record.get(e))&&t.visible||!u||null!=(t=this.intersectionObserver)&&t.unobserve(e),this.record.delete(e)},c.prototype.find=function(e){var t,n,r=null;try{for(var o=z(this.record),i=o.next();!i.done;i=o.next()){var a=x(i.value,2),u=a[0],c=a[1];if(u.currentSrc===e){r=L({target:u},c);break}}}catch(e){t={error:e}}finally{try{i&&!i.done&&(n=o.return)&&n.call(o)}finally{if(t)throw t.error}}return r},c);function c(){var n=this;this.record=new Map,this.intersectionObserver=null,u&&(this.intersectionObserver=new IntersectionObserver(function(e){e.forEach(function(e){var t;(e.isIntersecting||0<e.intersectionRatio)&&((t=n.record.get(e.target))&&n.record.set(e.target,L(L({},t),{visible:!0})),null!=(t=n.intersectionObserver)&&t.unobserve(e.target))})},{rootMargin:"200px"}))}function f(i,a,u){var c=1;return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=i.apply(void 0,s([],x(e),!1)),r=c+=2,o="string"==typeof e[0]?e[0]:e[0].url;a(r,o);return n.then(function(){u(r)},function(){u(r)}),n}}function d(n,o,i){var a=0;return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=a+=2;return o(r,this._url),l(this,"onreadystatechange",function(n){return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return 4===this.readyState&&i(r),n&&n.apply(this,e)}})(),n.apply(this,e)}}function p(c,s,e,l,f,d,p){if(void 0===c&&(c=M()),void 0===s&&(s=C()),void 0===e&&(e=M()&&window.location),void 0===l&&(l=function(){if("function"==typeof XMLHttpRequest&&r(XMLHttpRequest))return XMLHttpRequest}()),void 0===f&&(f=function(){if(M()&&t(window.performance))return window.performance}()),void 0===d&&(d=function(){if(M()&&r(window.MutationObserver))return window.MutationObserver}()),void 0===p&&(p=function(){if(M()&&r(window.PerformanceObserver))return window.PerformanceObserver}()),s&&c&&e)return function(e,t){var n=e.debug,e=e.sample_rate,y=void 0===e?B:e,g=k("imageReport",n);g("图片插件已注册，version:",Q);function a(e){g("图片资源上报",e),t&&t({ev_type:K,payload:e})}var r,m=x(T(f),2)[1],b=new j,e=x(W(),3),w=e[0],S=e[1],u=e[2],_=(r=function(){X.notify({ev_type:H,payload:{pageLoad:!0}})},n=M(),e=C(),n&&e&&("complete"===e.readyState?r():n.addEventListener("load",function(){setTimeout(function(){r()},0)},!1)),x(J(c,l,function(e){return g("before http 请求, url:",e),!0},function(e){e=_.get(e);g("after http 请求, url:",e),e&&_.size-1<G&&X.notify({ev_type:P,payload:{url:e,remainConnections:G-(_.size-1)}})}),1)[0]),e=x(N(d,function(e){var e=x(A(e),2),t=e[0],e=e[1];(t.length||e.length)&&g("监听到DOM变更",t,e),t.forEach(function(e){return b.set(e)}),e.forEach(function(e){return b.del(e)})}),2),n=e[0],o=e[1],e=(n(s,{childList:!0,subtree:!0,characterData:!1,attributes:!1}),x(D(p,function(e){var t,n,r,o,i,a,u,c,s,l,f,d,p,v,h,y,m;"img"!==e.initiatorType&&"css"!==e.initiatorType||(g("监听到resource",e),m=(h=e.toJSON()).name,y=h.initiatorType,t=h.transferSize,n=h.duration,r=h.encodedBodySize,o=h.decodedBodySize,i=h.redirectStart,a=h.redirectEnd,u=h.serverTiming,c=h.domainLookupStart,s=h.domainLookupEnd,l=h.connectStart,f=h.connectEnd,d=h.secureConnectionStart,p=h.requestStart,v=h.responseStart,h=h.responseEnd,"img"===(y={name:m,source:y,dpr:Math.round(null!=(m=null===window||void 0===window?void 0:window.devicePixelRatio)?m:1),needCompress:!1,needSizeOptim:!1,needFormatOptim:!1,hitLocalCache:0===t||void 0===t&&0===n,hitCdnCache:0<=(u||[]).findIndex(function(e){return"cdn-cache"===e.name&&0<=e.description.toLocaleLowerCase().indexOf("hit")}),size:0!==o?r:0,duration:n,redirect:a-i,dns:s-c,tcp:f-l,ssl:void 0===d||d<=0?0:f-d,request:void 0===p||p<=0?0:v-p,download:void 0===v||v<=0?0:h-v,timingDetail:e.toJSON()}).source&&(m=b.find(e.name),g("匹配到img",m,b.record),m&&(y=L(L({},y),{isLazyLoad:Boolean(m.visible),width:(null==(t=m.target)?void 0:t.naturalWidth)||0,height:(null==(u=m.target)?void 0:u.naturalHeight)||0,viewerWidth:null==(o=m.target)?void 0:o.width,viewerHeight:null==(r=m.target)?void 0:r.height}))),X.notify({ev_type:q,payload:y}))}),2)),n=e[0],i=e[1],O=function(o){return v(void 0,void 0,void 0,function(){var t,n,r;return h(this,function(e){switch(e.label){case 0:return(g("进行中的请求数：".concat(_.size)),0<G-_.size)?[4,F(o.name)]:[3,2];case 1:if(t=e.sent()||{},n=t.format,r=t.status,t=t.contentLength,g("response header：",n,r),"css"===o.source){if(null==n||!n.startsWith("image/"))return[2]}else if((null==n||!n.startsWith("image/"))&&Number(r)<400)return[2];return!(n=L(L({},o),{format:n&&String(n).startsWith("image/")?n.slice(6):void 0,status:r})).size&&Number(r)<400&&0<Number(t)&&(n.size=Number(t)),r=I(n),a(L(L({},n),r)),[3,3];case 2:S(o.name,L({},o)),e.label=3;case 3:return[2]}})})},E=function(o,i){return v(void 0,void 0,void 0,function(){var t,n,r;return h(this,function(e){switch(e.label){case 0:return[4,F(o)];case 1:if(t=e.sent()||{},n=t.format,r=t.status,t=t.contentLength,g("response header：",n,r),"css"===i.source){if(null==n||!n.startsWith("image/"))return u(o),[2]}else if((null==n||!n.startsWith("image/"))&&Number(r)<400)return u(o),[2];return!(n=L(L({},i||{}),{format:n&&String(n).startsWith("image/")?n.slice(6):void 0,status:r})).size&&Number(r)<400&&0<Number(t)&&(n.size=Number(t)),r=I(n),a(L(L({},n),r)),u(o),[2]}})})};X.subscribe(function(e){var t,n,r,o,i;if(e.ev_type===q){var a=m()-(null==(a=null==(a=e.payload)?void 0:a.timingDetail)?void 0:a.responseEnd);if(g("资源加载事件: ",e.payload.name),g("资源完成加载时间: ",null==(i=null==(i=e.payload)?void 0:i.timingDetail)?void 0:i.responseEnd),g("时间间隔: ",a),g("是否命中本地缓存: ",null==(i=e.payload)?void 0:i.hitLocalCache),!R(y))return;if(!Y)return void S(e.payload.name,L({},e.payload));O(e.payload)}if(e.ev_type===P&&Y){if(g("http请求完成事件"),e.payload.remainConnections<=0)return;try{for(var u=z(w),c=u.next();!c.done;c=u.next()){var s=x(c.value,2),l=s[0];if(null==(h=s[1])||!h.__lock){S(l,L(L({},h),{__lock:!0})),E(l,h);break}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(n=u.return)&&n.call(u)}finally{if(t)throw t.error}}}if(e.ev_type===H&&e.payload.pageLoad){g("pageload 事件");try{for(var f=z(w),d=f.next();!d.done;d=f.next()){var p=x(d.value,2),v=p[0],h=p[1];if(!(0<G-_.size))break;null!=h&&h.__lock||(S(v,L(L({},h),{__lock:!0})),E(v,h))}}catch(e){r={error:e}}finally{try{d&&!d.done&&(o=f.return)&&o.call(f)}finally{if(r)throw r.error}}Y=!0}}),n(U);return[function(){g("插件销毁"),o(),i()}]}}var W=function(){var n=new Map;return[n,function(e,t){return n.set(e,t)},function(e){return n.delete(e)}]},J=function(e,t,n,r){function o(e,t){n&&n(t)&&c(e,t)}function i(e){r&&r(e),s(e)}var a=x(W(),3),u=a[0],c=a[1],s=a[2];return t&&l(t.prototype,"send",d)(o,i),e&&l(e,"fetch",f)(o,i),[u]},F=function(r){return v(void 0,void 0,void 0,function(){var t,n;return h(this,function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,fetch(r,{cache:"force-cache"})];case 1:return t=e.sent(),n=t.headers,[2,{status:t.status,format:n.get("content-type")||"",contentLength:Number(n.get("content-length"))||0}];case 2:return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.log.apply(console,s(["[SDK]",Date.now(),(""+o++).padStart(8," ")],x(e),!1))}("获取header失败",e.sent()),[2,null];case 3:return[2]}})})},I=function(e){var t={needCompress:!1,needSizeOptim:!1,needFormatOptim:!1};if(!e.size)return t;o=(l=e).width,c=l.height,i=void 0===(i=l.format)?"":i,l=l.size,r=navigator&&navigator.userAgent.toLocaleLowerCase().includes("chrome"),s={},/(jpeg|png|bmp)/.test(i)&&(o&&c?(n=Math.round(Math.max(l-o*c*.2,0)),r?(o=Math.round(Math.max(l-o*c/6,0)),s.needFormatOptim=0<o,s.needFormatOptim&&(s.webpSavings=n,s.avifSavings=o)):(s.needFormatOptim=0<n,s.needFormatOptim&&(s.webpSavings=n))):(s.needFormatOptim=!0,s.webpSavings=Math.round(/png/.test(i)?.26*l:.3*l),r&&(s.avifSavings=Math.round(/png/.test(i)?.408*l:.44*l)))),/gif/.test(i)&&(s.needFormatOptim=!0,s.webpSavings=.65*l,r&&(s.avifSavings=.65*l));var n,r,o,i,a,u,c=s,s=(n=(o=e).width,i=o.height,r=void 0===(r=o.format)?"":r,o=o.size,l={},n&&i&&(/(jpeg|bmp)/.test(r)&&(a=o-n*i*.25,l.needCompress=0<a,l.needCompress&&(l.compressSavings=Math.round(a))),/png/.test(r)&&(a=o-n*i*4*.2*.3,l.needCompress=0<a,l.needCompress&&(l.compressSavings=Math.round(a)))),l),l=(o=(r=e).width,i=e.height,a=e.viewerWidth,l=e.viewerHeight,u=e.dpr,r=e.size,e={},o&&i&&a&&l&&(e.needSizeOptim=0<(a=1-a*l*u*u/(o*i)),e.needSizeOptim&&(e.resizeSavings=Math.round((1-a)*r))),e);return L(L(L(L({},t),c),s),l)},q="image_resource",P="http_custom",H="pageload",K="image",B=.1,Q="0.1.2",U="resource",G=4,X=new e,Y=!1,y={sample_rate:B};return function(n){return void 0===n&&(n=y),{name:"imageReport",setup:function(t){t.on("init",function(){var e=x(function(e,t,n,r){void 0===t&&(t={}),void 0===r&&(r=[]);try{var o=e.apply(void 0,s([],x(r),!1));return o&&o(t,n)||[]}catch(e){return i(e),[]}}(p,n,t.report.bind(t)),1)[0];t.on("beforeDestroy",function(){e()})})}}}});
